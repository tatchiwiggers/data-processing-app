name: CI Test Kubernetes Locally

on:
  workflow_run:
    workflows: ["CI Homolog - Docker"]
    types:
      - completed
  pull_request:
    branches:
      - master
jobs:
  test-k8s-locally:
    runs-on: ubuntu-latest
    environment: homolog
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
    - name: Checkout the code
      uses: actions/checkout@v3

    - name: Set up Docker
      uses: docker/setup-buildx-action@v3
      with:
        version: latest

    - name: Install KinD
      run: |
        curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.20.0/kind-linux-amd64
        chmod +x ./kind
        sudo mv ./kind /usr/local/bin/kind

    - name: Create Kubernetes cluster
      run: kind create cluster --name test-cluster

    - name: Install kubectl
      run: |
        curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
        chmod +x ./kubectl
        sudo mv ./kubectl /usr/local/bin/kubectl

    - name: Apply CronJob YAML
      run: |
        kubectl apply -f k8s/base/jobs/cronjob-app-mercadolivre.yml

    - name: Run the CronJob manually
      run: |
        kubectl create job --from=cronjob/app-mercado-livre-cron app-mercado-livre-manual
